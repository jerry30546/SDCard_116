#include "HAL/clock_hal.h"
#include "HAL/gpio_hal.h"
#include "HAL/uart_hal.h"
#include "HAL/spi_hal.h"
#include "HAL/timer_hal.h"
#include "modules/log/log.h"
#include "modules/time/time.h"
#include "modules/sdmc/sdmc.h"

#include <stdlib.h>

volatile int exit_code = 0;
uint8_t debug_verbose = 5;
uint8_t debug_instance = 0;
uint8_t spi_instance = 0;

uint8_t write_data[512] = { // Original data of SDMC 8192th block
		0xEB, 0x58, 0x90, 0x4D, 0x53, 0x44, 0x4F, 0x53,
		0x35, 0x2E, 0x30, 0x00, 0x02, 0x08, 0xDE, 0x09,
		0x02, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x00, 0x00,
		0x3F, 0x00, 0xFF, 0x00, 0x00, 0x20, 0x00, 0x00,
		0x00, 0xC0, 0xEC, 0x00, 0x11, 0x3B, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		0x01, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x80, 0x01, 0x29, 0x0B, 0xCA, 0x11, 0x3C, 0x4E,
		0x4F, 0x20, 0x4E, 0x41, 0x4D, 0x45, 0x20, 0x20,
		0x20, 0x20, 0x46, 0x41, 0x54, 0x33, 0x32, 0x20,
		0x20, 0x20, 0x33, 0xC9, 0x8E, 0xD1, 0xBC, 0xF4,
		0x7B, 0x8E, 0xC1, 0x8E, 0xD9, 0xBD, 0x00, 0x7C,
		0x88, 0x56, 0x40, 0x88, 0x4E, 0x02, 0x8A, 0x56,
		0x40, 0xB4, 0x41, 0xBB, 0xAA, 0x55, 0xCD, 0x13,
		0x72, 0x10, 0x81, 0xFB, 0x55, 0xAA, 0x75, 0x0A,
		0xF6, 0xC1, 0x01, 0x74, 0x05, 0xFE, 0x46, 0x02,
		0xEB, 0x2D, 0x8A, 0x56, 0x40, 0xB4, 0x08, 0xCD,
		0x13, 0x73, 0x05, 0xB9, 0xFF, 0xFF, 0x8A, 0xF1,
		0x66, 0x0F, 0xB6, 0xC6, 0x40, 0x66, 0x0F, 0xB6,
		0xD1, 0x80, 0xE2, 0x3F, 0xF7, 0xE2, 0x86, 0xCD,
		0xC0, 0xED, 0x06, 0x41, 0x66, 0x0F, 0xB7, 0xC9,
		0x66, 0xF7, 0xE1, 0x66, 0x89, 0x46, 0xF8, 0x83,
		0x7E, 0x16, 0x00, 0x75, 0x39, 0x83, 0x7E, 0x2A,
		0x00, 0x77, 0x33, 0x66, 0x8B, 0x46, 0x1C, 0x66,
		0x83, 0xC0, 0x0C, 0xBB, 0x00, 0x80, 0xB9, 0x01,
		0x00, 0xE8, 0x2C, 0x00, 0xE9, 0xA8, 0x03, 0xA1,
		0xF8, 0x7D, 0x80, 0xC4, 0x7C, 0x8B, 0xF0, 0xAC,
		0x84, 0xC0, 0x74, 0x17, 0x3C, 0xFF, 0x74, 0x09,
		0xB4, 0x0E, 0xBB, 0x07, 0x00, 0xCD, 0x10, 0xEB,
		0xEE, 0xA1, 0xFA, 0x7D, 0xEB, 0xE4, 0xA1, 0x7D,
		0x80, 0xEB, 0xDF, 0x98, 0xCD, 0x16, 0xCD, 0x19,
		0x66, 0x60, 0x80, 0x7E, 0x02, 0x00, 0x0F, 0x84,
		0x20, 0x00, 0x66, 0x6A, 0x00, 0x66, 0x50, 0x06,
		0x53, 0x66, 0x68, 0x10, 0x00, 0x01, 0x00, 0xB4,
		0x42, 0x8A, 0x56, 0x40, 0x8B, 0xF4, 0xCD, 0x13,
		0x66, 0x58, 0x66, 0x58, 0x66, 0x58, 0x66, 0x58,
		0xEB, 0x33, 0x66, 0x3B, 0x46, 0xF8, 0x72, 0x03,
		0xF9, 0xEB, 0x2A, 0x66, 0x33, 0xD2, 0x66, 0x0F,
		0xB7, 0x4E, 0x18, 0x66, 0xF7, 0xF1, 0xFE, 0xC2,
		0x8A, 0xCA, 0x66, 0x8B, 0xD0, 0x66, 0xC1, 0xEA,
		0x10, 0xF7, 0x76, 0x1A, 0x86, 0xD6, 0x8A, 0x56,
		0x40, 0x8A, 0xE8, 0xC0, 0xE4, 0x06, 0x0A, 0xCC,
		0xB8, 0x01, 0x02, 0xCD, 0x13, 0x66, 0x61, 0x0F,
		0x82, 0x74, 0xFF, 0x81, 0xC3, 0x00, 0x02, 0x66,
		0x40, 0x49, 0x75, 0x94, 0xC3, 0x42, 0x4F, 0x4F,
		0x54, 0x4D, 0x47, 0x52, 0x20, 0x20, 0x20, 0x20,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x0D, 0x0A, 0x44, 0x69,
		0x73, 0x6B, 0x20, 0x65, 0x72, 0x72, 0x6F, 0x72,
		0xFF, 0x0D, 0x0A, 0x50, 0x72, 0x65, 0x73, 0x73,
		0x20, 0x61, 0x6E, 0x79, 0x20, 0x6B, 0x65, 0x79,
		0x20, 0x74, 0x6F, 0x20, 0x72, 0x65, 0x73, 0x74,
		0x61, 0x72, 0x74, 0x0D, 0x0A, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xAC, 0x01, 0xB9, 0x01, 0x00, 0x00, 0x55, 0xAA
};


int main(void)
{
  /*** Processor Expert internal initialization. DON'T REMOVE THIS CODE!!! ***/
  #ifdef PEX_RTOS_INIT
    PEX_RTOS_INIT();                   /* Initialization of the selected RTOS. Macro is defined by the RTOS component. */
  #endif
  /*** End of Processor Expert internal initialization.                    ***/

    uint8_t rxBuf[1]; // Console receive buffer
    uint32_t sdmc_blocks = 0; // SDMC block size
    uint8_t *data; // SDMC block data
    uint32_t nBlock = 8192;

    // Initial Clock Manager
    clock_drv_init();

	// Initial Pin Mux
	gpio_drv_init();

	// Init UART for debug(log)
    uart_drv_init(debug_instance);

    // Init SPI for SDMC
    spi_drv_init(spi_instance, SPI_MASTER_MODE);

    // Turn on Green LED for indicate work status
    gpio_set_level(111, GPIO_LEVEL_HIGH);

    // Init time utilities
    time_init();

    log_debug("SDMC basic functions demonstration program!\r\n");
    log_debug("Please key in 's' first to initialize SDMC!\r\n");
    log_debug("You can key in 'i' to retrieve SDMC information\r\n");
    log_debug("You can key in 'r' to read SDMC block data\r\n");
    log_debug("You can key in 'e' to erase SDMC block\r\n");
    log_debug("You can key in 'w' to write data into SDMC block\r\n");
    log_debug("You can key in 'q' to quit program\r\n\n");

    while(rxBuf[0] != 'q') {
    	switch(rxBuf[0]) {
    	case 's': // Init SDMC in SPI mode
    		log_debug("Init SDMC...");
            if(sdmc_init()) {
            	log_error("Failed!\r\n");
            	log_error("Error Code=%d, Status=%d\r\n",
            			sdmc_get_error(), sdmc_get_status());
            } else {
            	log_info("success!\r\n");
            }
    		break;
    	case 'i': // Read SDMC information, must initial SDMC first!
    		sdmc_blocks = sdmc_get_blocks();
			log_debug("SDMC typeID=%d, block size=%lu, SDMC Volume = %lu MB\r\n",
					sdmc_get_type(),
					sdmc_blocks,
					sdmc_blocks/2/1024);

			cid_t cid;
			sdmc_rdcid(&cid);
			log_debug("SDMC Manufacturer ID = %d\r\n",cid.mid);
			log_debug("SDMC OEM ID = %c%c\r\n", cid.oid[0], cid.oid[1]);
			log_debug("SDMC Product Name = %c%c%c%c%c\r\n", cid.pnm[0], cid.pnm[1], cid.pnm[2], cid.pnm[3], cid.pnm[4]);
			log_debug("SDMC Product Version = %d.%d\r\n", cid.prv_n, cid.prv_m);
			log_debug("SDMC Product Serial Number = %02X%02X%02X%02X\r\n", cid.psn[0], cid.psn[1], cid.psn[2], cid.psn[3]);
			log_debug("SDMC Manufacturer Date = 20%d%d/%d\r\n", cid.mdt_year_high, cid.mdt_year_low, cid.mdt_month);
			log_debug("SDMC CID CRC = %02X\r\n", ((cid.crc << 1) | cid.always1));
    		break;
    	case 'r': // Dump block data
    		data = calloc(512, sizeof(uint8_t));
    		for(uint32_t i = 0; i < 1; i++) { // read 1 block
    			if(sdmc_rdblk(i + nBlock, data)) { // read 8192th block
    				log_error("SDMC read block error = %d, status = %d\r\n",
    						sdmc_get_error(), sdmc_get_status());
    				free(data);
					break;
    			}
    			log_info("SDMC Read Block %d ... success\r\n", i+nBlock);
    			for(uint16_t j = 0; j < 512;) {
    				for(uint16_t k = j%16; k < 16; k++, j++) {
    					log_debug(" %02X", *(data+j));
    				}
    				log_debug("\r\n");
    			}
    		}
    		free(data);
    		break;
    	case 'w':
    		if(sdmc_wrblk(nBlock, write_data, 1)) { // write data to 8192th block
    			log_error("SDMC write block error = %d, status = %d\r\n",
						sdmc_get_error(), sdmc_get_status());
    		} else {
    			log_info("SDMC write Block %d ... success\r\n", nBlock);
    		}
    		break;
    	case 'e':
    		if(sdmc_erase(nBlock, nBlock)) { // erase 8192th block
    			log_error("SDMC erase error = %d, status = %d\r\n",
    					sdmc_get_error(), sdmc_get_status());
    		} else {
    			log_warning("SDMC erase %dth block success!\r\n", nBlock);
    		}
    		break;
    	}
    	rxBuf[0] = 0x00;
    	uart_recv(debug_instance, rxBuf, 1);
    }
    gpio_set_level(111, GPIO_LEVEL_LOW);
    log_debug("Program Terminated!\r\n");

  /*** Don't write any code pass this line, or it will be deleted during code generation. ***/
  /*** RTOS startup code. Macro PEX_RTOS_START is defined by the RTOS component. DON'T MODIFY THIS CODE!!! ***/
  #ifdef PEX_RTOS_START
    PEX_RTOS_START();                  /* Startup of the selected RTOS. Macro is defined by the RTOS component. */
  #endif
  /*** End of RTOS startup code.  ***/
  /*** Processor Expert end of main routine. DON'T MODIFY THIS CODE!!! ***/
  for(;;) {
    if(exit_code != 0) {
      break;
    }
  }
  return exit_code;
  /*** Processor Expert end of main routine. DON'T WRITE CODE BELOW!!! ***/
} /*** End of main routine. DO NOT MODIFY THIS TEXT!!! ***/
